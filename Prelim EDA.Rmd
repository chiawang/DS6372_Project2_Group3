---
title: "Prelim EDA"
author: "Stats 2 Project Team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(naniar)
library(questionr)
library(rebus)
library(GGally)
library(gridExtra)
```

# Background
https://www.hindawi.com/journals/bmri/2014/781670/
http://downloads.hindawi.com/journals/bmri/2014/781670.pdf

To Do: Provide summary of paper, site as reference. 
_Beata Strack, Jonathan P. DeShazo, Chris Gennings, Juan L. Olmo, Sebastian Ventura, Krzysztof J. Cios, and John N. Clore, “Impact of HbA1c Measurement on Hospital Readmission Rates: Analysis of 70,000 Clinical Database Patient Records,” BioMed Research International, vol. 2014, Article ID 781670, 11 pages, 2014._

# Data Set
https://archive.ics.uci.edu/ml/datasets/diabetes+130-us+hospitals+for+years+1999-2008

The following is taken verbatim from above.

The dataset represents 10 years (1999-2008) of clinical care at 130 US hospitals and integrated delivery networks. It includes over 50 features representing patient and hospital outcomes. Information was extracted from the database for encounters that satisfied the following criteria.

* It is an inpatient encounter (a hospital admission).
* It is a diabetic encounter, that is, one during which any kind of diabetes was entered to the system as a diagnosis.
* The length of stay was at least 1 day and at most 14 days.
* Laboratory tests were performed during the encounter.
* Medications were administered during the encounter.

The data contains such attributes as patient number, race, gender, age, admission type, time in hospital, medical specialty of admitting physician, number of lab test performed, HbA1c test result, diagnosis, number of medication, diabetic medications, number of outpatient, inpatient, and emergency visits in the year before the hospitalization, etc.

## Dictionary

To Do: Provide dictionary of elements. This is provided in the paper's pdf. Let's copy it here and reference page 3 of Impact of HbA1c Measurement on Hospital Readmission Rates: Analysis of 70,000 Clinical Database Patient Records pdf document. The table can also be found here,

https://www.hindawi.com/journals/bmri/2014/781670/tab1/

## Import Data
```{r import}
data <- read.csv("diabetic_data.csv")
head(data)
```

Notice above that we having missing values represented by '?'. Let's replace '?' with NA.

```{r replace_missing}
data <- data %>% mutate_all(~na_if(., '?'))
```

Check variables with missing values.

```{r missing_percent}
gg_miss_var(data, show_pct=TRUE) + labs(title="Percent Missing by Data Field") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5),axis.title.y=element_text(angle=0,vjust=1))
```

Table alternative, I think I like this better.

```{r}
freq.na(data)
```

Things to consider

* Discharge Disposition - we should consider removing those related to hospice or death
* Consider grouping DX codes.
* Need to do something with age
* To Do - Consider using only the first encounter for a patient!!!!

### Remove observations where discharge dispostion is related to hospice or death
```{r discharge}
data <- data %>% filter(!data$discharge_disposition_id %in% c('11','13','14','19','20','21'))
```

### Let's only use the first encounter for a given patient_nbr. Assume the first encounter is the lowest.
```{r oneEncounter}
data <- data %>% group_by(patient_nbr) %>% filter(encounter_id == min(encounter_id))
```


### Create Buckets for Diagnosis Codes
Creating buckets for the ICD-9 codes, based on the following.
https://www.hindawi.com/journals/bmri/2014/781670/tab2/

```{r helper}
replaceDX <- function(df = data, rx, replaceValue) {
  df$diag_1[grep(rx,df$diag_1)] <- replaceValue
  df$diag_2[grep(rx,df$diag_2)] <- replaceValue
  df$diag_3[grep(rx,df$diag_3)] <- replaceValue
  
  return(df)
}
```

```{r}

# Create temporary data frame of bucketed DX codes

dx <- c("diag_1","diag_2","diag_3")
#dataDX <- data.frame(data[dx],stringsAsFactors = FALSE)
dataDX <- data[dx]
dataDX[] <- lapply(data[dx], as.character)

# Circulatory
label <- "Circulatory"
rx <- number_range(390,459)
dataDX <- replaceDX(dataDX, rx, label)
dataDX <- replaceDX(dataDX, "785", label)

# Respiratory
label <- "Respiratory"
rx <- number_range(460,519)
dataDX <- replaceDX(dataDX, rx, label)
dataDX <- replaceDX(dataDX, "786", label)

# Digestive
label <- "Digestive"
rx <- number_range(520,579)
dataDX <- replaceDX(dataDX, rx, label)
dataDX <- replaceDX(dataDX, "787", label)

# Diabetes
label <- "Diabetes"
rx <- number_range(250,250.99)
dataDX <- replaceDX(dataDX, rx, label)

# Injury
label <- "Injury"
rx <- number_range(800,999)
dataDX <- replaceDX(dataDX, rx, label)

# Musculoskeletal
label <- "Musculoskeletal"
rx <- number_range(710,739)
dataDX <- replaceDX(dataDX, rx, label)

# Genitourinary
label <- "Genitourinary"
rx <- number_range(580,629)
dataDX <- replaceDX(dataDX, rx, label)
dataDX <- replaceDX(dataDX, "788", label)

# Neoplasms
label <- "Neoplasms"

rx <- number_range(140,239)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(780,782)
dataDX <- replaceDX(dataDX, rx, label)
dataDX <- replaceDX(dataDX, "784", label)

rx <- number_range(790,799)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(240,279)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(680,709)
dataDX <- replaceDX(dataDX, rx, label)

# Number range here doesn't work as I would expect, probably because it spans 1 to 3 digits
# So I'll just create my own regEx object
# rx <- number_range(1,139)
rx <- regex("(?:^([1-9]|[1-8][0-9]|9[0-9]|1[0-2][0-9]|13[0-9])$)")
dataDX <- replaceDX(dataDX, rx, label)

# Other
label = "Other"

rx = "^E.*"
dataDX <- replaceDX(dataDX, rx, label)
rx = "^V.*"
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(290,319)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(280,289)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(320,359)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(630,679)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(360,389)
dataDX <- replaceDX(dataDX, rx, label)

rx <- number_range(740,759)
dataDX <- replaceDX(dataDX, rx, label)

# Now update main data table and set DX buckets as factors
data[dx] <- lapply(dataDX, as.factor)

#data$diag_1 <- as.factor(data$diag_1)
#data$diag_2 <- as.factor(data$diag_2)
#data$diag_3 <- as.factor(data$diag_3)

#data <- data.frame(data[dx],stringsAsFactors = TRUE)
```

Now let's check what levels we have. Looks like we still have codes 789 and 783, but paper didn't call them out. It could be that we still need to reduce the data set to the 60K+ observations they used. We can easily add them to the "Other" bucket if needed though.

```{r}
# Use plyr here, it looks better
plyr::count(data$diag_1)
```

Let's create an outcome column that is Yes if admitted within 30 days, and No for everything else.
```{r}
data$outcome <- factor(ifelse(data$readmitted == "<30","Yes","No"))
plyr::count(data$outcome)
```

Above we see that about 10% of our data shows as readmitted, so we have an inbalanced data set. Need to consider that in our analysis. See 
https://towardsdatascience.com/methods-for-dealing-with-imbalanced-data-5b761be45a18

### Adding in stuff based on Dr. Turner's R file, things to consider.

* Also add in EDA stuff from Project 1
* Based on DX groups alone, the percentage seems to be equally split for Yes/No
* Simple plots show days in hospital and number of inpatient days are signficant.

```{r}
#aggregate is good for summary stats by groups for continous predictors
#aggregate(data$time_in_hospital ~ data$outcome, data = data, summary)

#Visualize
plot(data$outcome ~ data$time_in_hospital,col=c("red","blue"))
plot(data$outcome ~ data$age,col=c("red","blue"))
```

### Proportion Plots

#### Age

* The bulk of the patients are in the age range of 40 - 90 years.
* The proportion of readimts increase from the lowest bucket up to the 80s bucket.

```{r, fig.width=12}
p1 <- data %>%
  ggplot(aes(x = age)) +
  geom_bar()
p2 <- data %>%
  ggplot(aes(x = age, fill = readmitted)) +
  geom_bar(position = 'fill') +
  coord_flip()
grid.arrange(p1, p2, ncol = 2)
```


#### Time in Hospital

This is the number of days a patient spent in the hospital.
The distribution is at max at 3 days, then tails off at the time increases.
Maximum observed value is 14 days.

```{r}
p1 <- data %>%
  ggplot(aes(x = time_in_hospital)) +
  geom_bar()
p2 <- data %>%
  ggplot(aes(x = time_in_hospital, fill = readmitted)) +
  geom_bar(position = 'fill') +
  coord_flip()
p3 <- data %>%
  ggplot(aes(x = readmitted, y = time_in_hospital)) +
  geom_boxplot()
grid.arrange(p1, p2, p3, ncol = 2)
```

























